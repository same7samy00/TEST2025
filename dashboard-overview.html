<div class="dashboard-overview">
    <header class="page-header">
        <h1>مرحباً بك في لوحة تحكم شيخ العرب</h1>
        <p>هنا يمكنك إدارة محل العطارة الخاص بك بكفاءة.</p>
    </header>

    <section class="overview-cards">
        <div class="card">
            <h3>إجمالي المنتجات</h3>
            <p id="totalProducts">جاري التحميل...</p>
        </div>
        <div class="card">
            <h3>مبيعات اليوم</h3>
            <p id="dailySales">جاري التحميل...</p>
        </div>
        <div class="card">
            <h3>منتجات على وشك النفاذ</h3>
            <p id="lowStockProducts">جاري التحميل...</p>
        </div>
        <div class="card">
            <h3>ديون العملاء الإجمالية</h3>
            <p id="totalCustomerDebt">جاري التحميل...</p>
        </div>
    </section>

    <section class="quick-actions">
        <h2>إجراءات سريعة</h2>
        <div class="actions-grid">
            <button class="action-btn" onclick="window.loadContent('products.html')">إضافة منتج جديد</button>
            <button class="action-btn" onclick="window.loadContent('sales.html')">تسجيل بيع</button>
            <button class="action-btn" onclick="window.loadContent('products.html')">عرض المنتجات</button>
            <button class="action-btn" onclick="window.loadContent('sales.html')">عرض المبيعات</button>
        </div>
    </section>

    <section class="recent-activity">
        <h2>الأنشطة الأخيرة</h2>
        <table>
            <thead>
                <tr>
                    <th>النوع</th>
                    <th>التفاصيل</th>
                    <th>التاريخ</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>إضافة منتج</td>
                    <td>تمت إضافة "زيت اللوز الحلو"</td>
                    <td>25 يوليو 2025</td>
                </tr>
                <tr>
                    <td>بيع</td>
                    <td>فاتورة #123456 بقيمة 350 جنيه</td>
                    <td>25 يوليو 2025</td>
                </tr>
                <tr>
                    <td>تعديل مخزون</td>
                    <td>تحديث كمية "عشب الروزماري"</td>
                    <td>24 يوليو 2025</td>
                </tr>
            </tbody>
        </table>
    </section>
</div>

<script type="module">
    import { getFirestore, collection, getDocs, query, where, Timestamp, sum } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js";

    const db = getFirestore(window.firebaseApp);

    const totalProductsElement = document.getElementById('totalProducts');
    const dailySalesElement = document.getElementById('dailySales');
    const lowStockProductsElement = document.getElementById('lowStockProducts');
    const totalCustomerDebtElement = document.getElementById('totalCustomerDebt');

    async function fetchDashboardData() {
        // إجمالي المنتجات
        try {
            const productsSnapshot = await getDocs(collection(db, 'products'));
            totalProductsElement.textContent = `${productsSnapshot.size} منتج`;
        } catch (error) {
            console.error("خطأ في جلب إجمالي المنتجات:", error);
            totalProductsElement.textContent = 'خطأ!';
        }

        // منتجات على وشك النفاذ (الكمية أقل من 10)
        try {
            const q = query(collection(db, 'products'), where('quantity', '<', 10));
            const lowStockSnapshot = await getDocs(q);
            lowStockProductsElement.textContent = `${lowStockSnapshot.size} منتج`;
        } catch (error) {
            console.error("خطأ في جلب منتجات على وشك النفاذ:", error);
            lowStockProductsElement.textContent = 'خطأ!';
        }

        // مبيعات اليوم
        const today = new Date();
        const timezoneOffset = today.getTimezoneOffset() * 60000;
        const localDate = new Date(today.getTime() - timezoneOffset);
        const startOfDay = new Date(localDate.getFullYear(), localDate.getMonth(), localDate.getDate(), 0, 0, 0);
        const endOfDay = new Date(localDate.getFullYear(), localDate.getMonth(), localDate.getDate(), 23, 59, 59);

        const startOfDayTimestamp = Timestamp.fromDate(startOfDay);
        const endOfDayTimestamp = Timestamp.fromDate(endOfDay);

        try {
            const salesQuery = query(
                collection(db, 'sales'),
                where('timestamp', '>=', startOfDayTimestamp),
                where('timestamp', '<=', endOfDayTimestamp)
            );
            const salesSnapshot = await getDocs(salesQuery);
            let totalSalesAmount = 0;
            salesSnapshot.forEach(doc => {
                const sale = doc.data();
                if (sale.totalAmount) {
                    totalSalesAmount += sale.totalAmount;
                }
            });
            dailySalesElement.textContent = `${totalSalesAmount.toFixed(2)} جنيه`;
        } catch (error) {
            console.error("خطأ في جلب مبيعات اليوم:", error);
            dailySalesElement.textContent = 'خطأ!';
        }

        // ديون العملاء الإجمالية
        try {
            const customersSnapshot = await getDocs(collection(db, 'customers'));
            let totalDebt = 0;
            customersSnapshot.forEach(doc => {
                const customer = doc.data();
                if (customer.outstandingBalance) {
                    totalDebt += customer.outstandingBalance;
                }
            });
            totalCustomerDebtElement.textContent = `${totalDebt.toFixed(2)} جنيه`;
        } catch (error) {
            console.error("خطأ في جلب ديون العملاء:", error);
            totalCustomerDebtElement.textContent = 'خطأ!';
        }
    }

    fetchDashboardData();
</script>
