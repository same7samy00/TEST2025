<div class="sales-management">
    <header class="page-header">
        <h1>نقطة البيع (POS)</h1>
        <p>تسجيل المبيعات اليومية وتحديث المخزون بسهولة.</p>
    </header>

    <div class="pos-container">
        <div class="pos-section product-search-section">
            <h3>البحث عن المنتجات</h3>
            <div class="form-group">
                <input type="text" id="productSearchInput" placeholder="ابحث باسم المنتج..." autocomplete="off">
                <div id="searchResults" class="search-results-dropdown">
                    </div>
            </div>
            <div id="selectedProductDetails" class="selected-product-details">
                </div>
            <div class="form-group quantity-input-group">
                <label for="quantityToSell">الكمية:</label>
                <input type="number" id="quantityToSell" min="0.01" step="0.01" value="1">
                <span id="selectedProductUnit" class="unit-display"></span>
            </div>
            <button class="action-btn add-to-cart-btn" id="addToCartButton">
                <i class="fas fa-cart-plus"></i> أضف إلى السلة
            </button>
        </div>

        <div class="pos-section cart-section">
            <h3>سلة المشتريات</h3>
            <table id="cartTable">
                <thead>
                    <tr>
                        <th>المنتج</th>
                        <th>الكمية</th>
                        <th>الإجمالي</th>
                        <th>إجراء</th>
                    </tr>
                </thead>
                <tbody>
                    <tr id="cartEmptyRow">
                        <td colspan="4" style="text-align: center; color: var(--light-text);">السلة فارغة</td>
                    </tr>
                </tbody>
            </table>
            <div class="cart-summary">
                <p>الإجمالي الفرعي: <span id="subtotalAmount">0.00</span> جنيه</p>
                <p>الخصم: <input type="number" id="discountInput" min="0" step="0.01" value="0.00"></p>
                <h3>الإجمالي الكلي: <span id="totalAmount">0.00</span> جنيه</h3>
            </div>
            <button class="submit-btn complete-sale-btn" id="completeSaleButton">
                <i class="fas fa-cash-register"></i> إتمام البيع
            </button>
            <button class="cancel-btn clear-cart-btn" id="clearCartButton">
                <i class="fas fa-trash-alt"></i> إفراغ السلة
            </button>
        </div>
    </div>
</div>

<script type="module">
    // التعديل هنا: حذف 'batch' من قائمة الاستيراد
    import { getFirestore, collection, getDocs, query, where, doc, updateDoc, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js";

    const db = getFirestore(window.firebaseApp); // استخدام تطبيق Firebase العام

    // عناصر الواجهة
    const productSearchInput = document.getElementById('productSearchInput');
    const searchResultsDiv = document.getElementById('searchResults');
    const selectedProductDetailsDiv = document.getElementById('selectedProductDetails');
    const quantityToSellInput = document.getElementById('quantityToSell');
    const selectedProductUnitSpan = document.getElementById('selectedProductUnit');
    const addToCartButton = document.getElementById('addToCartButton');
    const cartTableBody = document.querySelector('#cartTable tbody');
    const cartEmptyRow = document.getElementById('cartEmptyRow');
    const subtotalAmountSpan = document.getElementById('subtotalAmount');
    const discountInput = document.getElementById('discountInput');
    const totalAmountSpan = document.getElementById('totalAmount');
    const completeSaleButton = document.getElementById('completeSaleButton');
    const clearCartButton = document.getElementById('clearCartButton');

    let currentSelectedProduct = null; // المنتج المحدد حاليًا من البحث
    let cart = []; // سلة المشتريات

    // --- وظائف البحث عن المنتجات ---
    productSearchInput.addEventListener('input', async () => {
        const searchTerm = productSearchInput.value.trim();
        searchResultsDiv.innerHTML = '';
        if (searchTerm.length < 2) { // ابدأ البحث بعد حرفين على الأقل
            searchResultsDiv.style.display = 'none';
            return;
        }

        try {
            const productsRef = collection(db, 'products');
            // استعلام للبحث عن المنتجات التي تبدأ بالكلمة المدخلة
            const q = query(
                productsRef,
                where('name', '>=', searchTerm),
                where('name', '<=', searchTerm + '\uf8ff') // لإنهاء البحث "Starts with"
            );
            const querySnapshot = await getDocs(q);

            if (querySnapshot.empty) {
                searchResultsDiv.innerHTML = '<div class="search-result-item no-results">لا توجد نتائج مطابقة.</div>';
                searchResultsDiv.style.display = 'block';
                return;
            }

            querySnapshot.forEach(doc => {
                const product = { id: doc.id, ...doc.data() };
                const div = document.createElement('div');
                div.classList.add('search-result-item');
                div.textContent = `${product.name} (${product.quantity} ${product.unit} متوفر بسعر ${product.sellingPrice.toFixed(2)} جنيه)`;
                div.dataset.productId = product.id;
                div.addEventListener('click', () => selectProduct(product));
                searchResultsDiv.appendChild(div);
            });
            searchResultsDiv.style.display = 'block';
        } catch (error) {
            console.error("خطأ في البحث عن المنتجات:", error);
            searchResultsDiv.innerHTML = '<div class="search-result-item error-message">حدث خطأ أثناء البحث.</div>';
            searchResultsDiv.style.display = 'block';
        }
    });

    // إخفاء نتائج البحث عند النقر خارجها
    document.addEventListener('click', (e) => {
        if (!productSearchInput.contains(e.target) && !searchResultsDiv.contains(e.target)) {
            searchResultsDiv.style.display = 'none';
        }
    });

    function selectProduct(product) {
        currentSelectedProduct = product;
        productSearchInput.value = product.name; // لملء حقل البحث باسم المنتج
        searchResultsDiv.style.display = 'none'; // إخفاء نتائج البحث

        selectedProductDetailsDiv.innerHTML = `
            <p><strong>المنتج المحدد:</strong> ${product.name}</p>
            <p><strong>سعر الوحدة:</strong> ${product.sellingPrice.toFixed(2)} جنيه / ${product.unit}</p>
            <p><strong>الكمية المتوفرة:</strong> ${product.quantity} ${product.unit}</p>
        `;
        selectedProductDetailsDiv.style.display = 'block';
        selectedProductUnitSpan.textContent = product.unit; // عرض وحدة المنتج بجانب حقل الكمية
        quantityToSellInput.value = 1; // إعادة تعيين الكمية إلى 1 افتراضيا
        quantityToSellInput.focus();
    }

    // --- وظائف سلة المشتريات ---
    addToCartButton.addEventListener('click', () => {
        if (!currentSelectedProduct) {
            alert("الرجاء اختيار منتج أولاً.");
            return;
        }

        const quantity = parseFloat(quantityToSellInput.value);
        if (isNaN(quantity) || quantity <= 0) {
            alert("الرجاء إدخال كمية صحيحة وموجبة.");
            return;
        }
        if (quantity > currentSelectedProduct.quantity) {
            alert(`الكمية المطلوبة (${quantity} ${currentSelectedProduct.unit}) أكبر من الكمية المتوفرة (${currentSelectedProduct.quantity} ${currentSelectedProduct.unit}).`);
            return;
        }

        const itemTotal = quantity * currentSelectedProduct.sellingPrice;

        // التحقق إذا كان المنتج موجودًا بالفعل في السلة
        const existingItemIndex = cart.findIndex(item => item.id === currentSelectedProduct.id);
        if (existingItemIndex > -1) {
            // تحديث الكمية والسعر للمنتج الموجود
            cart[existingItemIndex].quantity += quantity;
            cart[existingItemIndex].total += itemTotal;
        } else {
            // إضافة منتج جديد إلى السلة
            cart.push({
                id: currentSelectedProduct.id,
                name: currentSelectedProduct.name,
                unit: currentSelectedProduct.unit,
                sellingPrice: currentSelectedProduct.sellingPrice,
                quantity: quantity,
                total: itemTotal,
                originalProduct: currentSelectedProduct // احتفظ بنسخة من بيانات المنتج الأصلية لتحديث المخزون
            });
        }
        
        currentSelectedProduct = null; // مسح المنتج المحدد
        productSearchInput.value = ''; // مسح حقل البحث
        selectedProductDetailsDiv.innerHTML = ''; // مسح تفاصيل المنتج
        selectedProductUnitSpan.textContent = ''; // مسح الوحدة المعروضة
        quantityToSellInput.value = 1; // إعادة تعيين الكمية

        renderCart(); // إعادة رسم السلة
        calculateTotals(); // إعادة حساب الإجمالي
    });

    function renderCart() {
        cartTableBody.innerHTML = ''; // مسح محتوى الجدول الحالي
        if (cart.length === 0) {
            cartEmptyRow.style.display = 'table-row';
            cartTableBody.appendChild(cartEmptyRow);
        } else {
            cartEmptyRow.style.display = 'none';
            cart.forEach((item, index) => {
                const row = cartTableBody.insertRow();
                row.innerHTML = `
                    <td>${item.name} (${item.unit})</td>
                    <td>${item.quantity.toFixed(2)}</td>
                    <td>${item.total.toFixed(2)}</td>
                    <td>
                        <button class="action-buttons delete-cart-item-btn" data-index="${index}">
                            <i class="fas fa-times"></i>
                        </button>
                    </td>
                `;
            });
        }
    }

    cartTableBody.addEventListener('click', (e) => {
        if (e.target.closest('.delete-cart-item-btn')) {
            const index = e.target.closest('.delete-cart-item-btn').dataset.index;
            cart.splice(index, 1); // حذف العنصر من السلة
            renderCart();
            calculateTotals();
        }
    });

    discountInput.addEventListener('input', calculateTotals);

    function calculateTotals() {
        let subtotal = cart.reduce((sum, item) => sum + item.total, 0);
        const discount = parseFloat(discountInput.value) || 0;
        
        subtotalAmountSpan.textContent = subtotal.toFixed(2);
        let total = subtotal - discount;
        if (total < 0) total = 0; // لا يمكن أن يكون الإجمالي بالسالب
        totalAmountSpan.textContent = total.toFixed(2);
    }

    clearCartButton.addEventListener('click', () => {
        if (confirm("هل أنت متأكد من رغبتك في إفراغ السلة بالكامل؟")) {
            cart = [];
            renderCart();
            calculateTotals();
            discountInput.value = 0;
        }
    });

    // --- إتمام عملية البيع ---
    completeSaleButton.addEventListener('click', async () => {
        if (cart.length === 0) {
            alert("السلة فارغة. لا يمكن إتمام عملية بيع.");
            return;
        }

        if (!confirm("هل أنت متأكد من إتمام عملية البيع؟")) {
            return;
        }

        try {
            // التعديل هنا: استخدام db.batch() مباشرة
            const batch = db.batch(); // إنشاء دفعة كتابة

            for (const item of cart) {
                const productRef = doc(db, 'products', item.id);
                // تأكد أن الكمية المتوفرة حالياً أكبر من الكمية المباعة لتجنب البيع الزائد لو حدث تحديث متزامن
                // (قد تحتاج لقواعد أمان أكثر صرامة في Firestore أو Cloud Functions لضمان هذا على نطاق واسع)
                const newQuantity = item.originalProduct.quantity - item.quantity;
                if (newQuantity < 0) {
                    throw new Error(`الكمية المتوفرة من ${item.name} غير كافية لإتمام البيع.`);
                }
                batch.update(productRef, { quantity: newQuantity });
            }

            // 2. تسجيل عملية البيع في Firestore
            const saleRecord = {
                items: cart.map(item => ({
                    productId: item.id,
                    name: item.name,
                    quantity: item.quantity,
                    unit: item.unit,
                    sellingPrice: item.sellingPrice,
                    total: item.total
                })),
                subtotal: parseFloat(subtotalAmountSpan.textContent),
                discount: parseFloat(discountInput.value),
                totalAmount: parseFloat(totalAmountSpan.textContent),
                timestamp: serverTimestamp() // تسجيل الوقت الحالي للبيع
            };
            batch.set(doc(collection(db, 'sales')), saleRecord); // استخدام set مع doc() بدون ID لتوليد ID تلقائياً

            await batch.commit(); // تنفيذ جميع العمليات دفعة واحدة

            alert("تم إتمام عملية البيع بنجاح!");
            cart = []; // إفراغ السلة
            renderCart(); // إعادة رسم السلة
            calculateTotals(); // إعادة حساب الإجمالي
            discountInput.value = 0;
            productSearchInput.value = '';
            selectedProductDetailsDiv.innerHTML = '';
            selectedProductUnitSpan.textContent = '';
            currentSelectedProduct = null;
        } catch (error) {
            console.error("خطأ في إتمام عملية البيع:", error);
            alert(`حدث خطأ أثناء إتمام عملية البيع: ${error.message || ''}. الرجاء المحاولة مرة أخرى.`);
            // يمكنك هنا إضافة منطق للتعامل مع الفشل، مثلاً إعادة المنتجات إلى السلة
        }
    });

    // تهيئة السلة عند تحميل الصفحة
    renderCart();
    calculateTotals();
</script>

<style>
    .pos-container {
        display: grid;
        grid-template-columns: 2fr 1fr; /* قسم للبحث وقسم للسلة */
        gap: 30px;
        margin-top: 40px;
    }

    .pos-section {
        background-color: var(--card-bg);
        padding: 30px;
        border-radius: 12px;
        box-shadow: 0 5px 15px var(--shadow-light);
        height: fit-content; /* لضمان أن الأقسام تأخذ الارتفاع المناسب */
    }

    .pos-section h3 {
        font-size: 26px;
        color: var(--primary-color);
        margin-bottom: 25px;
        text-align: right;
        border-bottom: 1px solid var(--border-color);
        padding-bottom: 10px;
    }

    /* قسم البحث عن المنتجات */
    #productSearchInput {
        width: calc(100% - 24px);
        padding: 12px;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        font-size: 16px;
        box-sizing: border-box;
        font-family: 'Cairo', sans-serif;
        margin-bottom: 10px;
    }

    .search-results-dropdown {
        position: relative; /* يجب أن يكون هذا أو parent للعنصر الموضع بشكل مطلق */
        max-height: 200px;
        overflow-y: auto;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        background-color: var(--card-bg);
        box-shadow: 0 5px 10px rgba(0, 0, 0, 0.08);
        z-index: 10;
        display: none; /* مخفية مبدئياً */
    }

    .search-result-item {
        padding: 12px 15px;
        cursor: pointer;
        border-bottom: 1px solid #eee;
        text-align: right;
        font-size: 15px;
        color: var(--text-color);
    }

    .search-result-item:last-child {
        border-bottom: none;
    }

    .search-result-item:hover {
        background-color: #f0fdf0;
    }

    .search-result-item.no-results, .search-result-item.error-message {
        color: var(--light-text);
        font-style: italic;
        padding: 15px;
    }
    .search-result-item.error-message {
        color: var(--danger-color);
    }

    .selected-product-details {
        background-color: #e8f5e9;
        border: 1px solid #c8e6c9;
        border-radius: 8px;
        padding: 15px;
        margin-top: 20px;
        margin-bottom: 20px;
        text-align: right;
        display: none; /* مخفية مبدئياً */
    }

    .selected-product-details p {
        margin: 5px 0;
        font-size: 16px;
        color: var(--text-color);
    }

    .quantity-input-group {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .quantity-input-group label {
        margin-bottom: 0; /* إزالة الهامش السفلي للـ label */
        flex-shrink: 0;
    }

    #quantityToSell {
        width: 100px; /* عرض ثابت لخانة الكمية */
        padding: 10px;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        font-size: 16px;
        box-sizing: border-box;
        font-family: 'Cairo', sans-serif;
        text-align: center;
    }

    .unit-display {
        font-size: 16px;
        color: var(--light-text);
        flex-shrink: 0;
    }

    .add-to-cart-btn {
        margin-top: 20px;
        width: 100%;
    }
    .add-to-cart-btn i {
        margin-left: 10px;
    }

    /* قسم سلة المشتريات */
    #cartTable {
        width: 100%;
        margin-top: 20px;
        margin-bottom: 20px;
    }

    #cartTable th, #cartTable td {
        padding: 12px;
        font-size: 15px;
    }
    #cartTable th:nth-child(2), #cartTable td:nth-child(2) { text-align: center; } /* الكمية */
    #cartTable th:nth-child(3), #cartTable td:nth-child(3) { text-align: left; } /* الإجمالي */
    #cartTable th:nth-child(4), #cartTable td:nth-child(4) { text-align: center; } /* إجراء */

    .delete-cart-item-btn {
        background-color: var(--danger-color);
        color: white;
        padding: 5px 10px;
        font-size: 13px;
        border-radius: 4px;
        transition: background-color 0.2s ease;
    }
    .delete-cart-item-btn:hover {
        background-color: #b71c1c;
    }

    .cart-summary {
        background-color: #f8fcf8;
        border: 1px solid #e8f5e9;
        border-radius: 8px;
        padding: 20px;
        margin-top: 20px;
        margin-bottom: 30px;
        text-align: right;
    }
    .cart-summary p, .cart-summary h3 {
        margin: 10px 0;
        color: var(--text-color);
        font-size: 18px;
    }
    .cart-summary h3 {
        font-size: 24px;
        color: var(--secondary-color);
        font-weight: 700;
        margin-top: 20px;
        border-top: 1px dashed var(--border-color);
        padding-top: 15px;
    }
    .cart-summary input[type="number"] {
        width: 100px;
        padding: 8px;
        border: 1px solid var(--border-color);
        border-radius: 5px;
        font-size: 16px;
        font-family: 'Cairo', sans-serif;
        text-align: left;
        margin-right: 10px; /* مسافة عن النص */
    }

    .complete-sale-btn, .clear-cart-btn {
        width: 100%;
        margin-bottom: 15px;
    }
    .complete-sale-btn i {
        margin-left: 10px;
    }
    .clear-cart-btn i {
        margin-left: 10px;
    }

    /* تعديلات للهواتف */
    @media (max-width: 768px) {
        .pos-container {
            grid-template-columns: 1fr; /* عمود واحد على الشاشات الصغيرة */
        }
        .pos-section {
            padding: 20px;
        }
        .pos-section h3 {
            font-size: 22px;
        }
        .cart-summary input[type="number"] {
            width: 80px;
        }
    }
</style>
