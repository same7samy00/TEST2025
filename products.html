<div class="products-management">
    <header class="page-header">
        <h1>إدارة المنتجات</h1>
        <p>أضف، عدّل، أو احذف المنتجات من مخزون محل شيخ العرب.</p>
    </header>

    <div class="product-form-container">
        <h3>أضف / عدّل منتج</h3>
        <form id="productForm">
            <input type="hidden" id="productId"> <div class="form-group">
                <label for="productName">اسم المنتج:</label>
                <input type="text" id="productName" required>
            </div>
            <div class="form-group">
                <label for="productCategory">الفئة:</label>
                <select id="productCategory" required>
                    <option value="">اختر فئة</option>
                    <option value="أعشاب">أعشاب</option>
                    <option value="توابل">توابل</option>
                    <option value="زيوت طبيعية">زيوت طبيعية</option>
                    <option value="مستحضرات تجميل طبيعية">مستحضرات تجميل طبيعية</option>
                    <option value="عسل ومشتقاته">عسل ومشتقاته</option>
                    <option value="ألبان">ألبان (جبنة، زبادي، إلخ)</option>
                    <option value="حبوب وبقوليات">حبوب وبقوليات</option>
                    <option value="مكسرات">مكسرات</option>
                    <option value="أخرى">أخرى</option>
                </select>
            </div>
            <div class="form-group">
                <label for="productUnit">الوحدة الأساسية:</label>
                <select id="productUnit" required>
                    <option value="">اختر وحدة</option>
                    <option value="كيلو جرام">كيلو جرام</option>
                    <option value="جرام">جرام</option>
                    <option value="لتر">لتر</option>
                    <option value="مليلتر">مليلتر</option>
                    <option value="قطعة">قطعة</option>
                    <option value="حبة">حبة</option>
                    <option value="عبوة">عبوة</option>
                    <option value="كيس">كيس</option>
                    <option value="مجموعة">مجموعة</option>
                </select>
            </div>
            <div class="form-group">
                <label for="productQuantity">الكمية المتاحة:</label>
                <input type="number" id="productQuantity" min="0" required>
            </div>
            <div class="form-group">
                <label for="purchasePrice">سعر الشراء (للوحدة الأساسية):</label>
                <input type="number" id="purchasePrice" step="0.01" min="0" required>
            </div>
            <div class="form-group">
                <label for="sellingPrice">سعر البيع (للوحدة الأساسية):</label>
                <input type="number" id="sellingPrice" step="0.01" min="0" required>
            </div>
            <div class="form-group">
                <label for="productBarcode">باركود/QR:</label>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <input type="text" id="productBarcode" placeholder="أدخل الباركود يدوياً أو امسح">
                    <button type="button" id="scanBarcodeBtn" class="action-btn" style="width: auto; padding: 10px 15px; flex-shrink: 0;">
                        <i class="fas fa-barcode"></i> مسح
                    </button>
                </div>
            </div>
            <div id="scannerContainer" style="display: none; margin-top: 20px; border: 1px solid var(--border-color); border-radius: 8px; overflow: hidden;">
                <div id="reader" style="width:100%; max-width: 400px; margin: auto;"></div>
                <button type="button" id="stopScannerBtn" class="cancel-btn" style="width: 100%; margin-top: 10px;">
                    <i class="fas fa-stop-circle"></i> إيقاف المسح
                </button>
            </div>

            <div class="form-group">
                <label for="productDescription">الوصف:</label>
                <textarea id="productDescription"></textarea>
            </div>
            <div class="form-actions">
                <button type="submit" class="submit-btn">حفظ المنتج</button>
                <button type="button" class="cancel-btn" id="cancelEdit">إلغاء</button>
            </div>
        </form>
    </div>

    <h2>المنتجات المتوفرة</h2>
    <p id="productsLoading" style="text-align: center; color: var(--light-text);">جاري تحميل المنتجات...</p>
    <table id="productsTable">
        <thead>
            <tr>
                <th>اسم المنتج</th>
                <th>الفئة</th>
                <th>الكمية</th>
                <th>الوحدة</th>
                <th>سعر الشراء</th>
                <th>سعر البيع</th>
                <th>باركود</th>
                <th>الإجراءات</th>
            </tr>
        </thead>
        <tbody>
            </tbody>
    </table>
</div>

<script type="module">
    import { getFirestore, collection, addDoc, getDocs, doc, updateDoc, deleteDoc, getDoc, query, where } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js";

    const db = getFirestore(window.firebaseApp);

    const productForm = document.getElementById('productForm');
    const productIdInput = document.getElementById('productId');
    const productNameInput = document.getElementById('productName');
    const productCategorySelect = document.getElementById('productCategory');
    const productUnitSelect = document.getElementById('productUnit');
    const productQuantityInput = document.getElementById('productQuantity');
    const purchasePriceInput = document.getElementById('purchasePrice'); // حقل جديد
    const sellingPriceInput = document.getElementById('sellingPrice');
    const productBarcodeInput = document.getElementById('productBarcode'); // حقل جديد
    const productDescriptionTextarea = document.getElementById('productDescription');
    const productsTableBody = document.querySelector('#productsTable tbody');
    const productsLoadingMessage = document.getElementById('productsLoading');
    const cancelEditButton = document.getElementById('cancelEdit');
    const scanBarcodeBtn = document.getElementById('scanBarcodeBtn');
    const scannerContainer = document.getElementById('scannerContainer');
    const stopScannerBtn = document.getElementById('stopScannerBtn');

    let editingProductId = null;
    let html5QrCode = null; // لكائن HTML5QrcodeScanner

    // بدء/إيقاف الماسح الضوئي
    scanBarcodeBtn.addEventListener('click', async () => {
        scannerContainer.style.display = 'block';
        if (!html5QrCode) {
            html5QrCode = new Html5Qrcode("reader");
        }
        
        // التحقق من الأذونات للكاميرا قبل البدء
        try {
            await navigator.mediaDevices.getUserMedia({ video: true });
        } catch (err) {
            alert('الرجاء السماح بالوصول إلى الكاميرا لاستخدام ماسح الباركود.');
            scannerContainer.style.display = 'none';
            return;
        }

        html5QrCode.start(
            { facingMode: "environment" }, // استخدام الكاميرا الخلفية على الأجهزة المحمولة
            {
                fps: 10,    // معدل الإطارات
                qrbox: { width: 250, height: 250 } // حجم منطقة المسح
            },
            (decodedText, decodedResult) => {
                // عند المسح بنجاح
                console.log(`Code matched = ${decodedText}`, decodedResult);
                productBarcodeInput.value = decodedText; // وضع الكود في حقل الباركود
                html5QrCode.stop().then(() => {
                    scannerContainer.style.display = 'none';
                    // هنا يمكننا البحث عن المنتج بهذا الباركود لوضع بياناته للتعديل
                    checkProductByBarcode(decodedText);
                }).catch((err) => {
                    console.error("Failed to stop scanning:", err);
                });
            },
            (errorMessage) => {
                // خطأ في المسح (ليس بالضرورة خطأ، يمكن أن يكون مجرد فشل في التعرف)
                // console.log(`No code recognized: ${errorMessage}`);
            }
        ).catch((err) => {
            console.error("Error starting camera:", err);
            alert("حدث خطأ في بدء تشغيل الكاميرا. تأكد من إعطاء الأذونات أو عدم وجود كاميرا أخرى تستخدم.");
            scannerContainer.style.display = 'none';
        });
    });

    stopScannerBtn.addEventListener('click', () => {
        if (html5QrCode && html5QrCode.is </script>
</body>
</html>
